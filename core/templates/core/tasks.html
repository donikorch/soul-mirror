{% extends 'core/base.html' %}

{% block title %}–ó–∞–¥–∞–Ω–∏—è - –ó–µ—Ä–∫–∞–ª–æ –î—É—à–∏{% endblock %}

{% block content %}
<div class="tasks-container">
    <h1>üìö –ó–∞–¥–∞–Ω–∏—è –¥–ª—è —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è</h1>
    <p class="subtitle">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã —Ä–∞–∑–≤–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–∑–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –∑–æ–¥–∏–∞–∫–∞</p>

    <div class="tasks-tabs">
        <button class="tab-btn active" data-tab="assigned">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</button>
        <button class="tab-btn" data-tab="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</button>
        <button class="tab-btn" data-tab="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>

    <div class="tab-content active" id="assigned">
        <h2>–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
        {% if assigned_tasks %}
        <div class="tasks-grid">
            {% for task in assigned_tasks %}
            <div class="task-card">
                <div class="task-header">
                    <span class="task-type-badge">{{ task.get_task_type_display }}</span>
                    <span class="task-sign">‚Üí {{ task.target_sign.get_name_display }}</span>
                </div>
                <h3>{{ task.title }}</h3>
                {% if task.author %}
                <p class="task-author">{{ task.author }}</p>
                {% endif %}
                <p>{{ task.description }}</p>
                <div class="task-footer">
                    <span class="task-reward">+{{ task.experience_reward }} XP</span>
                    <button class="btn btn-small btn-secondary" onclick="startTask({{ task.id }})">
                        –ù–∞—á–∞—Ç—å
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">–ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
        {% endif %}
    </div>

    <div class="tab-content" id="in_progress">
        <h2>–ó–∞–¥–∞–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</h2>
        {% if in_progress_tasks %}
        <div class="tasks-grid">
            {% for task in in_progress_tasks %}
            <div class="task-card">
                <div class="task-header">
                    <span class="task-type-badge">{{ task.get_task_type_display }}</span>
                    <span class="task-sign">‚Üí {{ task.target_sign.get_name_display }}</span>
                </div>
                <h3>{{ task.title }}</h3>
                {% if task.author %}
                <p class="task-author">{{ task.author }}</p>
                {% endif %}
                <p>{{ task.description }}</p>
                <div class="task-footer">
                    <span class="task-reward">+{{ task.experience_reward }} XP</span>
                    <button class="btn btn-small btn-primary" onclick="completeTask({{ task.id }})">
                        –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</p>
        {% endif %}
    </div>

    <div class="tab-content" id="completed">
        <h2>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
        {% if completed_tasks %}
        <div class="tasks-grid">
            {% for task in completed_tasks %}
            <div class="task-card completed">
                <div class="task-header">
                    <span class="task-type-badge">{{ task.get_task_type_display }}</span>
                    <span class="task-sign">‚Üí {{ task.target_sign.get_name_display }}</span>
                </div>
                <h3>{{ task.title }}</h3>
                {% if task.author %}
                <p class="task-author">{{ task.author }}</p>
                {% endif %}
                <p>{{ task.description }}</p>
                <div class="task-footer">
                    <span class="completed-badge">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                    <span class="task-reward">+{{ task.experience_reward }} XP</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
        {% endif %}
    </div>
</div>

<script>
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tab = this.getAttribute('data-tab');

        // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // –î–æ–±–∞–≤–ª—è–µ–º active –∫ —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç—É
        this.classList.add('active');
        document.getElementById(tab).classList.add('active');
    });
});

// –ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
function startTask(taskId) {
    GlobalLoader.show('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ...');

    fetch(`/tasks/${taskId}/start/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            GlobalLoader.hide();
        }
    })
    .catch(error => {
        GlobalLoader.hide();
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
function completeTask(taskId) {
    if (!confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ?')) {
        return;
    }

    GlobalLoader.show('–í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ...');

    fetch(`/tasks/${taskId}/complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `üéâ –û—Ç–ª–∏—á–Ω–æ! –í—ã –ø–æ–ª—É—á–∏–ª–∏ +${data.experience_gained} –æ–ø—ã—Ç–∞!`;

            if (data.user_leveled_up) {
                message += `\n\n‚≠ê –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ ${data.new_user_level} —É—Ä–æ–≤–Ω—è!`;
            }

            if (data.sign_level_up) {
                message += `\n\n‚ú® –í–∞—à –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ –ø–æ–≤—ã—Å–∏–ª —É—Ä–æ–≤–µ–Ω—å!`;
            }

            if (data.sign_changed) {
                message += `\n\nüîÆ –í–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∑–Ω–∞–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ ${data.new_sign_name}!`;
                if (data.old_tasks_removed > 0) {
                    message += `\n–°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è (${data.old_tasks_removed}) –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã.`;
                }
            }

            alert(message);
            location.reload();
        } else {
            GlobalLoader.hide();
        }
    })
    .catch(error => {
        GlobalLoader.hide();
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}
</script>
{% endblock %}
