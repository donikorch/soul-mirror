{% extends 'core/base.html' %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - –ó–µ—Ä–∫–∞–ª–æ –î—É—à–∏{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="welcome-section">
        <h1>üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}!</h1>
    </div>

    <div class="dashboard-grid">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="card profile-card">
            <h2>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="zodiac-display">
                <div class="zodiac-sign">{{ profile.inner_sign.get_name_display }}</div>
                <p class="sign-description">–í–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞</p>
            </div>
            <div class="stats">
                <div class="stat">
                    <span class="stat-label">–£—Ä–æ–≤–µ–Ω—å</span>
                    <span class="stat-value">{{ user.level }}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">–û–ø—ã—Ç</span>
                    <span class="stat-value">{{ user.total_experience }} XP</span>
                </div>
            </div>
        </div>

        <!-- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–æ–≤–µ—Ç —Å–æ scratch-off —ç—Ñ—Ñ–µ–∫—Ç–æ–º -->
        <div class="card daily-advice-card">
            <h2>–°–æ–≤–µ—Ç –¥–Ω—è –æ—Ç –∑–≤–µ–∑–¥</h2>
            {% if not daily_advice.is_revealed %}
            <div class="scratch-card" id="scratchCard">
                <canvas id="scratchCanvas"></canvas>
                <div class="scratch-text" id="scratchText">
                    {{ daily_advice.advice }}
                </div>
                <div class="scratch-hint">–ü–æ—Ç—Ä–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
            </div>
            {% else %}
            <div class="revealed-advice">
                <p>{{ daily_advice.advice }}</p>
            </div>
            {% endif %}
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
        <div class="card entries-card">
            <div class="card-header-with-link">
                <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h2>
                <a href="{% url 'entries_history' %}" class="view-all-link">–í—Å–µ –∑–∞–ø–∏—Å–∏ ‚Üí</a>
            </div>
            {% if recent_entries %}
            <ul class="entries-list">
                {% for entry in recent_entries %}
                <li class="entry-item">
                    <div class="entry-date">{{ entry.created_at|date:"d.m.Y" }}</div>
                    <div class="entry-emotion">
                        –≠–º–æ—Ü–∏—è: <span class="emotion-level emotion-{{ entry.emotion_level }}">{{ entry.emotion_level }}/10</span>
                    </div>
                    <div class="entry-text">{{ entry.event_description|truncatewords:15 }}</div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π. –ù–∞—á–Ω–∏—Ç–µ –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫!</p>
            {% endif %}
            <a href="{% url 'daily_entry' %}" class="btn btn-secondary">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</a>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è -->
        <div class="card tasks-card">
            <div class="card-header-with-link">
                <h2>–¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
                <a href="{% url 'tasks' %}" class="view-all-link">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è ‚Üí</a>
            </div>
            {% if active_tasks %}
            <div class="tasks-grid">
                {% for task in active_tasks %}
                <div class="task-card-item">
                    <div class="task-header">
                        <span class="task-type-badge task-type-{{ task.task_type }}">
                            {% if task.task_type == 'book' %}üìö
                            {% elif task.task_type == 'movie' %}üé¨
                            {% elif task.task_type == 'series' %}üì∫
                            {% elif task.task_type == 'meditation' %}üßò
                            {% elif task.task_type == 'affirmation' %}‚ú®
                            {% elif task.task_type == 'challenge' %}üéØ
                            {% endif %}
                            {{ task.get_task_type_display }}
                        </span>
                        <span class="task-reward-badge">+{{ task.experience_reward }} XP</span>
                    </div>
                    <h3 class="task-title">{{ task.title }}</h3>
                    <p class="task-description">{{ task.description|truncatewords:15 }}</p>
                    <div class="task-footer">
                        <span class="task-sign">üåü {{ task.target_sign.name }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Scratch-off —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞
{% if not daily_advice.is_revealed %}
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('scratchCanvas');
    const ctx = canvas.getContext('2d');
    const scratchCard = document.getElementById('scratchCard');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas
    canvas.width = scratchCard.offsetWidth;
    canvas.height = scratchCard.offsetHeight;

    // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–µ–±—Ä—è–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    gradient.addColorStop(0, '#c0c0c0');
    gradient.addColorStop(0.5, '#e0e0e0');
    gradient.addColorStop(1, '#c0c0c0');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏
    ctx.fillStyle = '#666';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('‚ú® –ü–æ—Ç—Ä–∏—Ç–µ –∑–¥–µ—Å—å ‚ú®', canvas.width / 2, canvas.height / 2);

    let isDrawing = false;
    let scratchedPercentage = 0;

    function scratch(x, y) {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(x, y, 30, 0, 2 * Math.PI);
        ctx.fill();

        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —Å—Ç–µ—Ä—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let transparent = 0;
        for (let i = 3; i < imageData.data.length; i += 4) {
            if (imageData.data[i] === 0) transparent++;
        }
        scratchedPercentage = (transparent / (imageData.data.length / 4)) * 100;

        // –ï—Å–ª–∏ —Å—Ç–µ—Ä—Ç–æ –±–æ–ª–µ–µ 50%, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
        if (scratchedPercentage > 50) {
            revealAdvice();
        }
    }

    function revealAdvice() {
        canvas.style.opacity = '0';
        setTimeout(() => {
            canvas.style.display = 'none';
        }, 300);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('{% url "reveal_advice" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
    }

    // Mouse events
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        scratch(e.clientX - rect.left, e.clientY - rect.top);
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isDrawing) {
            const rect = canvas.getBoundingClientRect();
            scratch(e.clientX - rect.left, e.clientY - rect.top);
        }
    });

    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
    });

    // Touch events
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        scratch(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (isDrawing) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            scratch(touch.clientX - rect.left, touch.clientY - rect.top);
        }
    });

    canvas.addEventListener('touchend', () => {
        isDrawing = false;
    });
});
{% endif %}
</script>
{% endblock %}
